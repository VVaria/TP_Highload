# TP_Highload
Домашнее задание по курсу технопарка Highload

# Tumblr

# MVP
1. Авторизация/регистрация
2. Создание блога/постов
3. Просмотр ленты рекомендаций

# Целевая аудитория
* 320 млн посещений в месяц
* 7,2 млн новых блогов создаются ежемесячно
* приблизительно 9,7 млн. пользователей, посещающих платформу ежедневно
* 22 млн постов каждый день
* среднее время, проведенное на платформе 9 минут
* платформа используется по всему миру
  * 50% трафика - Северная Америка (в основном США)
  * 30% - Европа
  * 12% - Азия
  * 3% - Австралия

# Расчет нагрузки
### Продуктовые метрики
1. Месячная аудитория составляет около 320 млн. уникальных посещений
2. Дневная аудитория - 10,3 млн пользователей
3. Если взять общее количество аккаунтов 490 млн и всего опубликованных постов ~180 млрд, то получаем 
```
180000 / 480 = 367 постов на один блог (нужно учитывать, что есть блоги, которые постоянно публикуют посты и их там больше, а в некоторых может быть 10 постов)
```
Вес одного поста при загрузке изображения или gif достигает 3мб, видео - до 100мб. При хранении размер картинок ужимается до ~1Мб, gif до 0,8Мб, видео до 5Мб в среднем. Данные о хранимом размере были получены путем анализа загрузки страницы при скролле рекомендаций. На сайте подгружались картинки, гифки, видео. В разделе Network можно было посмотреть размер данных.
Большей частью постов являются изображения - ~85%, gif - ~10%, видео - ~5%. Данная информация была взята путем анализа статистики из источников, а также анализом загружаемых постов  в ленте рекомендаций. Сервис tumblr изначально был создан для того, чтобы делиться каринками в постах, именно они и занимают большую часть хранилища, gif были добавлены в 2018 году. Загрузка видео в посты не так велика, потому что на этом сервисе attention span к видео мал. 
```
(0.85 * 1 + 0.1 * 0,8 + 0.05 * 5) * 367 = 433Мб примерно хранилище одного пользователя
```
4. Среднее время просмотра ленты составляет 9 минут, если считать, что показывается по 4 поста в течение 5 секунд, то за 9 минут подгружается
```
4 * 9 * 60 / 5 = 432 поста  
```
При скролле страницы в течении 10 секунд отправляется 2000 запросов на одного пользователя (использовался WireShark)
```
10 млн * 2000 * 6 * 9 = 1 млрд запросов в день
```
5. Каждый день создается около 50Гб новых постов и 2.7Тб обновлений списков последователей
6. Ежемесячно 330 млн уникальных посещений, это пирблизительно 10 млн посещений в день из них около 5% авторизаций => примерно 500тыс запросов на авторизацию.
   Годовой прирост аудитории ~ 30 млн пользователей:
```
30 млн / 365 = 82 тыс запросов на регистрацию в день
```

### Технические метрики
1. Общее количество постов ~180 млрд, из них 85% - изображения, 10% - gif, 5% - видео.
```
0.85 * 180млрд * 1 / (1024 ^ 3) = 142,4Пб - изображения
0.1 * 180млрд * 0,8 / (1024 ^ 3) = 13,4Пб - gif
0.05 * 180млрд * 5 / (1024 ^ 3) = 41,9Пб - видео
480 млн * 10 / 1024 ^ 2 = 4,5 Тб - остальная информация (о пользователях, тексты и тд)
```
2. Сетевой трафик
  * При создании: 22 млн постов каждый день, средний размер поста еще не в сжатом состоянии 3Мб + верстка и отдача контента.
 ```
 22млн / (24 * 60 * 60) * 3 ~ 763 Мб/с 
 ```
  * При загрузке ленты: 110 млн запросов на выгрузку постов в день. В каждом запросе по 40 постов + отдача верстки, текста
  ```
  110млн * 40 / (24 * 60 * 60) * 40 / 1024 ~ 2100Мб/с - пиковая нагрузка
  ```
 3. RPS: 
 
 Запрос          |      RPS      | Доп. информация при расчетах       
 :-------------: | :-----------: | :--------------------------------: 
 Регистрации     | 1             | 82 тыс. запросов в день            
 Авторизации     | 5             | 500 тыс. запросов в день             
 Создание блога  | 3             | 7,2 млн созданий ежемесячно       
 Создание постов | 1440          | 1427 постов создается в секунду[2] 
 Просмотр ленты  | 23000         | 110 млн запросов в день, 10 млн посещений            


# Логическая схема
![image](https://user-images.githubusercontent.com/34479597/142927884-4e7cd008-2c45-4de3-bdc2-fe32509f3a20.png)

# Физическая схема
База пользователей будет храниться в реляционной СУБД MySQL. Внутренним сервисам необходим доступ к потоку всех событий в системе (создание, редактирование и удаление постов), для чего можно создать внутреннюю шину сообщений c использованием Kafka. Для Users.id, Posts.id, Posts.user делаем hash-индексацию для быстрого поиска и сравнения.

# Используемые источники
1. https://onlypult.com/ru/blog/gid-po-rabote-v-tumblr-dlya-nachinauschih
2. https://saasscout.com/statistics/tumblr-statistics/
3. https://www.statista.com/topics/2463/tumblr/
4. https://www.insight-it.ru/highload/2012/arkhitektura-tumblr/
